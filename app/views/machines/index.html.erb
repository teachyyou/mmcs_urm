<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homepage</title>
  <style>
      .home-button {
          padding: 10px;
          width: 150px;
      }

      .machines-container {
          display: flex;
          flex-direction: column;
          align-content: center;
          justify-content: flex-end;
          height: 85vh;
          margin-top: 20px;
          margin-bottom: 20px;
          overflow-y: scroll;
      }

      /* Модальное окно */
      .modal {
          display: none; /* Скрыто по умолчанию */
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0);
          background-color: rgba(0,0,0,0.4); /* Черный с прозрачностью */
          padding-top: 60px;
      }

      .modal-content {
          background-color: #fefefe;
          margin: 5% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
      }

      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }

      .close:hover,
      .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
  </style>
</head>
<body>
<div style="display: flex; height: 100%; width: 100%; top: 0; left: 0; position: fixed; flex-direction:column; align-content: stretch;">

  <div style="background-color: #007bff; color: white; height: 80px; display: flex; align-items: center; justify-content: center; position: relative; padding: 30px; margin: 0px; font-size: 35px;">
    <div style="flex-grow: 1; text-align: center;">URM Machines</div>
    <div style="position: absolute; right: 20px;">
      <% if user_signed_in? %>
        <%= button_to "Выйти", destroy_user_session_path, method: :delete, class: 'base-button home-button' %>
      <% else %>
        <%= button_to "Регистрация", new_user_registration_path, method: :get, class: 'base-button home-button' %>
        <%= button_to "Войти", new_user_session_path, method: :get, class: 'base-button home-button' %>
      <% end %>
    </div>
  </div>

  <div style="display: flex; flex-direction:row; ">
    <div style="width: 50%; height: 100%; border-right: 1px solid #ccc;">
      <div style="display: flex; justify-content: stretch;" class="machines-container">
        <% @machines.each do |machine| %>
          <button style="padding: 20px; margin: 5px 10px;" 
          class="base-button show-machine-button" data-machine-id="<%= machine.id %>">
            <%= machine.name %>
          </button>
          <% if user_signed_in? &&  machine.author == current_user.id%>
              <%= button_to "Редактировать", edit_machine_path(machine), method: :get, class: 'base-button home-button' %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; width: 50%; padding-left: 20px; margin-top: auto; margin-bottom: auto; min-height: 100vh;">
      <div style="height: 70%; border-bottom: 1px solid #ccc;">
        <h1 id="selected-machine-name">Имя</h1>
        <div style="background-color: #f3f3f3; min-height: 20vh; border: 3px solid #007bff;">
          <p id="selected-machine-description" style="padding-left: 10px;">Описание</p>
        </div>
        <div style="display: flex; flex-direction: row; justify-content:space-around;">
          <button style="margin: 15px;" class='base-button home-button'>Запустить</button>
        </div>
      </div>

      <div style="height: 30%;">
        <div style="margin-top: 20px; display: flex; flex-direction: row; 
        justify-content:space-around;">
          <button id="create-button" class='base-button home-button'>Создать</button>
          <button class='base-button home-button'>Раскодировать</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>Только авторизованные пользователи могут создавать новые машины.</p>
  </div>
</div>

<script>
    // Открытие модального окна
    document.getElementById('create-button').onclick = function() {
        <% if !user_signed_in? %>
        document.getElementById('myModal').style.display = "block";
        <% else %>
        window.location.href = '/machines/new'; // Переход к странице создания машины
        <% end %>
    }

    // Закрытие модального окна
    document.getElementsByClassName("close")[0].onclick = function() {
        document.getElementById('myModal').style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('myModal')) {
            document.getElementById('myModal').style.display = "none";
        }
    }

    function registerMachineButtons() {
        const machinesContainer = document.querySelector('.machines-container');
        machinesContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('show-machine-button')) {
                const button = event.target;
                const machineId = button.getAttribute('data-machine-id');
                const machineName = document.getElementById('selected-machine-name');
                const machineDescription = document.getElementById('selected-machine-description');
                fetch('<%= show_machine_path(id: 0) %>'.replace('0', machineId), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        machineName.textContent = data.name;
                        machineDescription.textContent = data.description;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        });
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", registerMachineButtons);
    } else {
        registerMachineButtons();
    }
</script>

</body>
</html>